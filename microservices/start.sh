#!/bin/bash

# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð¼Ð¸ÐºÑ€Ð¾ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²

echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº Ð¼Ð¸ÐºÑ€Ð¾ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð² Ozon..."

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Docker
if ! command -v docker &> /dev/null; then
    echo "âŒ Docker Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½"
    exit 1
fi

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Docker Compose
if ! command -v docker-compose &> /dev/null; then
    echo "âŒ Docker Compose Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½"
    exit 1
fi

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸
echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¹..."
mkdir -p logs
mkdir -p data
mkdir -p nginx/ssl

# ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ñ„Ð°Ð¹Ð»Ñ‹ Ð¸Ð· Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð³Ð¾ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
echo "ðŸ“‹ ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð¾Ð²..."
cp ../ozon_api.py ./
cp ../cache_manager.py ./
cp ../api_metrics.py ./
cp ../api_monitor.py ./
cp ../forecast.py ./
cp ../telegram_notify.py ./
cp ../sheets.py ./
cp ../config.py ./

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ .env Ñ„Ð°Ð¹Ð» ÐµÑÐ»Ð¸ ÐµÐ³Ð¾ Ð½ÐµÑ‚
if [ ! -f .env ]; then
    echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ .env Ñ„Ð°Ð¹Ð»Ð°..."
    cat > .env << EOF
# Ozon API Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸
OZON_CLIENT_ID=your_client_id
OZON_API_KEY=your_api_key
OZON_BASE_URL=https://api-seller.ozon.ru

# Telegram Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸
TELEGRAM_BOT_TOKEN=your_bot_token
TELEGRAM_CHAT_ID=your_chat_id

# Google Sheets Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸
GOOGLE_SHEETS_CREDENTIALS_FILE=credentials.json
SPREADSHEET_ID=your_spreadsheet_id

# ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…
DATABASE_URL=postgresql://ozon_user:ozon_password@postgres:5432/ozon_microservices

# ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Redis
REDIS_URL=redis://redis:6379

# ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ RabbitMQ
RABBITMQ_URL=amqp://guest:guest@rabbitmq:5672/

# ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð°
API_MONITORING_ENABLED=true
API_MONITORING_INTERVAL=300
API_HEALTHY_THRESHOLD=200
API_DEGRADED_THRESHOLD=1000

# ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð¼ÐµÑ‚Ñ€Ð¸Ðº
API_METRICS_ENABLED=true
API_METRICS_RETENTION_DAYS=30
API_METRICS_RESPONSE_TIME_THRESHOLD=5000
API_METRICS_ERROR_RATE_THRESHOLD=5.0
API_METRICS_SUCCESS_RATE_THRESHOLD=95.0
EOF
    echo "âš ï¸  ÐžÑ‚Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ .env Ñ„Ð°Ð¹Ð» Ñ Ð²Ð°ÑˆÐ¸Ð¼Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ°Ð¼Ð¸"
fi

# ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹
echo "ðŸ›‘ ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ñ… ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²..."
docker-compose down

# Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÑÐµÑ€Ð²Ð¸ÑÑ‹
echo "ðŸ”¨ Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¸ Ð·Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²..."
docker-compose up --build -d

# Ð–Ð´ÐµÐ¼ Ð·Ð°Ð¿ÑƒÑÐºÐ° ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²
echo "â³ ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ° ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²..."
sleep 30

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²
echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ° ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²..."
docker-compose ps

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð·Ð´Ð¾Ñ€Ð¾Ð²ÑŒÐµ API Gateway
echo "ðŸ¥ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð´Ð¾Ñ€Ð¾Ð²ÑŒÑ API Gateway..."
curl -f http://localhost:8000/health || echo "âŒ API Gateway Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½"

echo ""
echo "âœ… ÐœÐ¸ÐºÑ€Ð¾ÑÐµÑ€Ð²Ð¸ÑÑ‹ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ñ‹!"
echo ""
echo "ðŸ“Š Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ ÑÐµÑ€Ð²Ð¸ÑÑ‹:"
echo "  - API Gateway: http://localhost:8000"
echo "  - Data Service: http://localhost:8001"
echo "  - Forecast Service: http://localhost:8002"
echo "  - Notification Service: http://localhost:8003"
echo "  - Monitoring Service: http://localhost:8004"
echo "  - Storage Service: http://localhost:8005"
echo "  - Nginx: http://localhost:80"
echo ""
echo "ðŸ”§ Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ:"
echo "  - ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ Ð»Ð¾Ð³Ð¾Ð²: docker-compose logs -f"
echo "  - ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°: docker-compose down"
echo "  - ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº: docker-compose restart"
echo ""
echo "ðŸ“ˆ ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³:"
echo "  - RabbitMQ Management: http://localhost:15672 (guest/guest)"
echo "  - Redis: localhost:6379"
echo "  - PostgreSQL: localhost:5432" 