# Документация модуля прогнозирования закупок

## Обзор

Модуль `forecast.py` предоставляет комплексную систему для прогнозирования потребности в закупках товаров на основе исторических данных о продажах и текущих остатках.

## Основные компоненты

### 1. DataValidator
Класс для валидации и очистки входных данных.

#### Методы:
- `validate_sales_data()` - валидация данных о продажах
- `validate_stocks_data()` - валидация данных об остатках
- `clean_sales_data()` - очистка данных о продажах от выбросов
- `clean_stocks_data()` - очистка данных об остатках

### 2. PurchaseForecast
Основной класс для расчета прогнозов закупок.

#### Ключевые методы:

##### Подготовка данных
- `prepare_sales_data()` - подготовка данных о продажах
- `prepare_stocks_data()` - подготовка данных об остатках

##### Расчет прогнозов
- `calculate_daily_sales()` - расчет средней дневной продажи
- `calculate_forecast()` - основной расчет прогноза закупок
- `identify_oos_days()` - идентификация дней отсутствия товара

##### Аналитика и отчетность
- `generate_purchase_report()` - генерация отчета о закупках
- `get_forecast_analytics()` - аналитика по прогнозу
- `analyze_seasonality()` - анализ сезонности продаж
- `get_forecast_recommendations()` - рекомендации по улучшению

##### Экспорт данных
- `export_report_to_csv()` - экспорт в CSV
- `export_report_to_json()` - экспорт в JSON с метаданными
- `generate_telegram_message()` - сообщение для Telegram
- `create_forecast_summary_report()` - текстовый отчет

##### Валидация и контроль качества
- `validate_forecast_data()` - валидация результатов прогноза
- `compare_with_historical_forecast()` - сравнение с историческими данными
- `generate_dashboard_data()` - данные для дашборда

## Качество прогноза

Система оценивает качество прогноза по следующим категориям:

- **GOOD** - достаточное количество исторических данных
- **LOW_DATA** - мало данных для точного прогноза
- **NO_SALES** - нет данных о продажах
- **NO_SALES_DATA** - отсутствуют данные о продажах

## Уровни уверенности

- **HIGH** - высокая уверенность (≥30 дней данных)
- **MEDIUM** - средняя уверенность (14-29 дней данных)
- **LOW** - низкая уверенность (<14 дней данных)
- **VERY_LOW** - очень низкая уверенность (нет продаж)

## Срочность закупок

- **HIGH** - критическая срочность (<10 дней до исчерпания)
- **MEDIUM** - средняя срочность (10-20 дней)
- **LOW** - низкая срочность (>20 дней)

## Пример использования

```python
from forecast import PurchaseForecast

# Создание экземпляра
forecast = PurchaseForecast()

# Подготовка данных
sales_df = forecast.prepare_sales_data(sales_data)
stocks_df = forecast.prepare_stocks_data(stocks_data)

# Расчет прогноза
forecast_df = forecast.calculate_forecast(sales_df, stocks_df)

# Генерация отчета
report = forecast.generate_purchase_report(forecast_df)

# Экспорт
forecast.export_report_to_csv(report)
forecast.export_report_to_json(report)

# Telegram сообщение
message = forecast.generate_telegram_message(report)
```

## Структура отчета

### CSV формат
Содержит следующие колонки:
- `sku` - код товара
- `avg_daily_sales` - средняя дневная продажа
- `current_stock` - текущий остаток
- `days_until_stockout` - дней до исчерпания
- `recommended_quantity` - рекомендуемое количество
- `moq` - минимальная партия
- `forecast_quality` - качество прогноза
- `confidence` - уровень уверенности
- `urgency` - срочность

### JSON формат
Дополнительно включает:
- Метаданные (дата генерации, версия)
- Сводная статистика
- Детальная информация по каждому SKU

## Анализ сезонности

Модуль анализирует:
- Продажи по дням недели
- Продажи по месяцам
- Пиковые периоды продаж

## Рекомендации

Система генерирует рекомендации по:
- Улучшению качества данных
- Срочным закупкам
- Проверке аномальных продаж
- Анализу товаров с нулевой продажей

## Валидация данных

### Проверки для продаж:
- Наличие обязательных полей
- Корректность типов данных
- Отсутствие отрицательных значений
- Выявление выбросов

### Проверки для остатков:
- Логическая корректность (зарезервировано ≤ общего остатка)
- Отсутствие отрицательных значений
- Корректность типов данных

## Логирование

Все операции логируются с указанием:
- Количества обработанных записей
- Найденных ошибок
- Статистики по качеству данных
- Рекомендаций по улучшению

## Тестирование

Для тестирования используется `test_forecast.py`, который:
- Генерирует тестовые данные
- Проверяет все функции модуля
- Демонстрирует работу экспорта
- Показывает примеры отчетов

## Интеграция

Модуль интегрируется с:
- Системой мониторинга API
- Telegram уведомлениями
- Микросервисной архитектурой
- Системой кэширования

## Конфигурация

Настройки берутся из `config.py`:
- `DAYS_FORECAST_SHORT` - краткосрочный прогноз (40 дней)
- `DAYS_FORECAST_LONG` - долгосрочный прогноз (120 дней)
- `SALES_HISTORY_DAYS` - период анализа продаж
- `get_moq_for_sku()` - функция получения минимальной партии 